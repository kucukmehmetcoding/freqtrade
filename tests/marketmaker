# pragma pylint: disable=missing-docstring, invalid-name, pointless-string-statement
# flake8: noqa: F401
# isort: skip_file
import numpy as np
import pandas as pd
from pandas import DataFrame
from functools import reduce
from datetime import datetime, timedelta
from typing import Dict, Optional, Union, Tuple
import warnings
warnings.filterwarnings('ignore')

from freqtrade.strategy import (
    IStrategy,
    Trade,
    Order,
    PairLocks,
    informative,
    BooleanParameter,
    CategoricalParameter,
    DecimalParameter,
    IntParameter,
    RealParameter,
    timeframe_to_minutes,
    timeframe_to_next_date,
    timeframe_to_prev_date,
    merge_informative_pair,
    stoploss_from_absolute,
    stoploss_from_open,
    AnnotationType,
)

import talib.abstract as ta
from technical import qtpylib

class MarketMakerStrategy(IStrategy):
    """
    MARKET MAKER STRATEGY - Piyasa YapÄ±cÄ± MantÄ±ÄŸÄ±yla Ters Ä°ÅŸlem
    """
    INTERFACE_VERSION = 3
    timeframe = '5m'
    can_short: bool = False

    # REVERSAL STRATEJÄ°SÄ° - Trend dÃ¶nÃ¼ÅŸlerini yakala
    stoploss = -0.030
    trailing_stop = False

    # SCALPING ROI - KÃ¼Ã§Ã¼k ama sÄ±k kar
    minimal_roi = {
        "0": 0.008,    # %0.8
        "2": 0.005,    # 2 candle sonra %0.5
        "6": 0.002     # 6 candle sonra %0.2
    }

    def populate_indicators(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
        # FÄ°YAT HAREKETÄ° GÃ–STERGELERÄ°
        dataframe['pivot_high'] = dataframe['high'].rolling(10).max()
        dataframe['pivot_low'] = dataframe['low'].rolling(10).min()

        # VOLUME ANALÄ°ZÄ°
        dataframe['volume_ma'] = dataframe['volume'].rolling(20).mean()
        dataframe['volume_ratio'] = dataframe['volume'] / dataframe['volume_ma']

        # BASÄ°T MOMENTUM
        dataframe['rsi'] = ta.RSI(dataframe, timeperiod=14)
        dataframe['price_change'] = dataframe['close'].pct_change(5)

        # SUPPORT/RESISTANCE
        dataframe['resistance'] = dataframe['high'].rolling(15).max()
        dataframe['support'] = dataframe['low'].rolling(15).min()
        dataframe['mid_point'] = (dataframe['resistance'] + dataframe['support']) / 2

        return dataframe

    def populate_entry_trend(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
        """
        TERS (REVERSAL) STRATEJÄ°SÄ° - AÅŸÄ±rÄ± uÃ§lardan dÃ¶nÃ¼ÅŸ bekleyen
        """
        pair = metadata.get('pair', '')

        # SENARYO 1: DÄ°P ALIM (Oversold Reversal)
        oversold_conditions = [
            dataframe['rsi'] < 28,                      # AÅŸÄ±rÄ± oversold
            dataframe['close'] <= dataframe['support'] * 1.005,  # Support testi
            dataframe['volume_ratio'] > 1.3,            # Volume spike
            dataframe['price_change'] < -0.03,          # Son 5 periyot dÃ¼ÅŸÃ¼ÅŸ
            dataframe['close'] < dataframe['mid_point'] # Alt yarÄ±da
        ]

        # SENARYO 2: TEpe SATIÅž (Overbought Reversal) - Uzun iÃ§in deÄŸil ama mantÄ±k
        # Burada sadece LONG yapÄ±yoruz, bu yÃ¼zden overbought'tan kaÃ§Ä±nÄ±yoruz

        # SENARYO 3: BREAKOUT FAILURE - DirenÃ§ testi baÅŸarÄ±sÄ±z
        failure_conditions = [
            dataframe['close'] >= dataframe['resistance'] * 0.995,  # DirenÃ§ testi
            dataframe['rsi'] > 65,                      # Overbought'a yakÄ±n
            dataframe['volume_ratio'] < 0.8,            # Volume dÃ¼ÅŸÃ¼k (breakout onayÄ± yok)
            dataframe['close'] < dataframe['close'].shift(1)  # DirenÃ§ten dÃ¼ÅŸÃ¼ÅŸ
        ]

        scenario1 = reduce(lambda x, y: x & y, oversold_conditions)
        scenario3 = reduce(lambda x, y: x & y, failure_conditions)

        final_condition = scenario1 | scenario3

        # DEBUG
        entry_count = final_condition.sum()
        if entry_count > 0:
            print(f"ðŸŽ¯ {pair} - {entry_count} reversal sinyali")

        dataframe.loc[final_condition, 'enter_long'] = 1
        return dataframe

    def populate_exit_trend(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
        """
        HEDEF ODAKLI Ã‡IKIÅž - KÃ¼Ã§Ã¼k karlarÄ± garantile
        """
        conditions = []

        # 1. ORTA SEVÄ°YE HEDEF
        conditions.append(dataframe['close'] >= dataframe['mid_point'])

        # 2. RSI NORMALLEÅžME
        conditions.append(dataframe['rsi'] > 45)

        # 3. KÃœÃ‡ÃœK KAR HEDEFÄ° (%2-3)
        price_increase = (dataframe['close'] / dataframe['close'].shift(3) - 1) > 0.02
        conditions.append(price_increase)

        # HERHANGÄ° BÄ°R KOÅžUL â†’ Ã‡IKIÅž
        exit_condition = reduce(lambda x, y: x | y, conditions)

        dataframe.loc[exit_condition, 'exit_long'] = 1
        return dataframe

    def custom_stoploss(self, pair: str, trade: Trade, current_time: datetime,
                       current_rate: float, current_profit: float, **kwargs) -> float:
        """
        AGGRESÄ°F STOP-LOSS - KÃ¼Ã§Ã¼k kayÄ±plarla Ã§Ä±k
        """
        # Ä°lk 2 candle: SÄ±kÄ± stop
        trade_duration = (current_time - trade.open_date_utc).total_seconds() / 3600

        if trade_duration < 8:  # 4H'de 2 candle
            return -0.012  # %1.2
        elif current_profit > 0.005:  # %0.5 kar
            return -0.008  # %0.8
        else:
            return -0.015  # %1.5

    def leverage(self, pair: str, current_time: datetime, current_rate: float,
                 proposed_leverage: float, max_leverage: float, entry_tag: Optional[str],
                 side: str, **kwargs) -> float:
        return 1.0

    @property
    def plot_config(self):
        return {
            "main_plot": {
                "pivot_high": {"color": "red"},
                "pivot_low": {"color": "green"},
                "mid_point": {"color": "yellow"}
            },
            "subplots": {
                "RSI": {
                    "rsi": {"color": "purple"}
                },
                "Volume": {
                    "volume_ratio": {"color": "blue", "type": "bar"}
                }
            }
        }







        ===================================================
        from freqtrade.strategy.interface import IStrategy
from functools import reduce
import talib.abstract as ta
from pandas import DataFrame
from datetime import datetime
from freqtrade.persistence import Trade
from typing import Optional

class MarketMakerStrategy(IStrategy):
    """
    OPTIMIZED MARKET MAKER - BaÅŸarÄ±lÄ± Stratejinin GeliÅŸtirilmiÅŸ Hali
    """
    INTERFACE_VERSION = 3
    timeframe = '5m'
    can_short: bool = False

    # Ã–NCEKÄ° BAÅžARILI AYARLAR
    stoploss = -0.030
    trailing_stop = False

    # ROI - Ã–NCEKÄ° BAÅžARILI AYARLAR
    minimal_roi = {
        "0": 0.008,    # %0.8
        "2": 0.005,    # 2 candle sonra %0.5
        "6": 0.002     # 6 candle sonra %0.2
    }

    def populate_indicators(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
        # Ã–NCEKÄ° BAÅžARILI GÃ–STERGELER
        dataframe['pivot_high'] = dataframe['high'].rolling(10).max()
        dataframe['pivot_low'] = dataframe['low'].rolling(10).min()
        dataframe['volume_ma'] = dataframe['volume'].rolling(20).mean()
        dataframe['volume_ratio'] = dataframe['volume'] / dataframe['volume_ma']
        dataframe['rsi'] = ta.RSI(dataframe, timeperiod=14)
        dataframe['price_change'] = dataframe['close'].pct_change(5)
        dataframe['resistance'] = dataframe['high'].rolling(15).max()
        dataframe['support'] = dataframe['low'].rolling(15).min()
        dataframe['mid_point'] = (dataframe['resistance'] + dataframe['support']) / 2

        # SADECE 1 EK GÃ–STERGE: Stochastic for confirmation
        stoch = ta.STOCH(dataframe)
        dataframe['stoch_k'] = stoch['slowk']
        dataframe['stoch_d'] = stoch['slowd']

        return dataframe

    def populate_entry_trend(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
        """
        Ã–NCEKÄ° BAÅžARILI GÄ°RÄ°Åž + KÃœÃ‡ÃœK Ä°YÄ°LEÅžTÄ°RMELER
        """
        pair = metadata.get('pair', '')

        # SENARYO 1: DÄ°P ALIM (Ã–nceki BaÅŸarÄ±lÄ± KoÅŸullar)
        oversold_conditions = [
            dataframe['rsi'] < 28,                      # AÅŸÄ±rÄ± oversold
            dataframe['close'] <= dataframe['support'] * 1.005,  # Support testi
            dataframe['volume_ratio'] > 1.3,            # Volume spike
            dataframe['price_change'] < -0.03,          # Son 5 periyot dÃ¼ÅŸÃ¼ÅŸ
            dataframe['close'] < dataframe['mid_point'], # Alt yarÄ±da
            # YENÄ°: Stochastic onayÄ± (Ã§ok hafif)
            dataframe['stoch_k'] < 35                   # Stochastic oversold
        ]

        # SENARYO 2: BREAKOUT FAILURE (Ã–nceki BaÅŸarÄ±lÄ± KoÅŸullar)
        failure_conditions = [
            dataframe['close'] >= dataframe['resistance'] * 0.995,  # DirenÃ§ testi
            dataframe['rsi'] > 65,                      # Overbought'a yakÄ±n
            dataframe['volume_ratio'] < 0.8,            # Volume dÃ¼ÅŸÃ¼k
            dataframe['close'] < dataframe['close'].shift(1),  # DirenÃ§ten dÃ¼ÅŸÃ¼ÅŸ
            # YENÄ°: Stochastic onayÄ± (Ã§ok hafif)
            dataframe['stoch_k'] > 65                   # Stochastic overbought
        ]

        scenario1 = reduce(lambda x, y: x & y, oversold_conditions)
        scenario2 = reduce(lambda x, y: x & y, failure_conditions)

        final_condition = scenario1 | scenario2

        # DEBUG
        entry_count = final_condition.sum()
        if entry_count > 0:
            print(f"ðŸŽ¯ {pair} - {entry_count} reversal sinyali")

        dataframe.loc[final_condition, 'enter_long'] = 1
        return dataframe

    def populate_exit_trend(self, dataframe: DataFrame, metadata: dict) -> DataFrame:
        """
        Ã–NCEKÄ° BAÅžARILI Ã‡IKIÅž + KÃœÃ‡ÃœK Ä°YÄ°LEÅžTÄ°RMELER
        """
        conditions = []

        # 1. ORTA SEVÄ°YE HEDEF (Ã–nceki gibi)
        conditions.append(dataframe['close'] >= dataframe['mid_point'])

        # 2. RSI NORMALLEÅžME (Ã–nceki gibi)
        conditions.append(dataframe['rsi'] > 45)

        # 3. KÃœÃ‡ÃœK KAR HEDEFÄ° (Ã–nceki gibi)
        price_increase = (dataframe['close'] / dataframe['close'].shift(3) - 1) > 0.02
        conditions.append(price_increase)

        # YENÄ°: Stochastic overbought Ã§Ä±kÄ±ÅŸÄ± (hafif)
        conditions.append(dataframe['stoch_k'] > 80)

        # HERHANGÄ° BÄ°R KOÅžUL â†’ Ã‡IKIÅž (Ã–nceki gibi)
        exit_condition = reduce(lambda x, y: x | y, conditions)

        dataframe.loc[exit_condition, 'exit_long'] = 1
        return dataframe

    def custom_stoploss(self, pair: str, trade: Trade, current_time: datetime,
                       current_rate: float, current_profit: float, **kwargs) -> float:
        """
        Ã–NCEKÄ° BAÅžARILI STOP-LOSS
        """
        trade_duration = (current_time - trade.open_date_utc).total_seconds() / 3600

        if trade_duration < 8:
            return -0.012  # %1.2
        elif current_profit > 0.005:
            return -0.008  # %0.8
        else:
            return -0.015  # %1.5

    def leverage(self, pair: str, current_time: datetime, current_rate: float,
                 proposed_leverage: float, max_leverage: float, entry_tag: Optional[str],
                 side: str, **kwargs) -> float:
        return 1.0

    @property
    def plot_config(self):
        return {
            "main_plot": {
                "pivot_high": {"color": "red"},
                "pivot_low": {"color": "green"},
                "mid_point": {"color": "yellow"}
            },
            "subplots": {
                "RSI": {
                    "rsi": {"color": "purple"}
                },
                "Volume": {
                    "volume_ratio": {"color": "blue", "type": "bar"}
                }
            }
        }



        =====================
        "BTC/USDT",
        "DOT/USDT",
        "SOL/USDT",
        "AVAX/USDT",
        "NEAR/USDT",
        "HBAR/USDT"